
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum DecisionStatus {
  IN_PROCESS
  WAITING
  SUCCESSFUL
  FAILED
  DISCARDED
}

model User {
  id String @id @default(uuid())
  email String @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  topics Topic[]
  decisions Decision[]
  otpCodes OtpCode[]
  refreshTokens RefreshToken[]
}

model Topic {
  id String @id @default(uuid())
  userId String
  title String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  decisions Decision[]
}

model Decision {
  id String @id @default(uuid())
  topicId String
  userId String
  parentId String?

  title String
  description String
  status DecisionStatus 
  order Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  parent Decision? @relation("DecisionHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Decision[] @relation("DecisionHierarchy")
}

model OtpCode {
  id String @id @default(uuid())
  userId String
  codeHash String
  expiresAt DateTime
  used Boolean @default(false)
  attempts Int @default(0)
  createdAt DateTime @default(now())

  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, used, expiresAt])
}

model RefreshToken {

  id String @id @default(uuid())
  token String @unique
  userId String
  expiresAt DateTime
  revoked Boolean @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}



